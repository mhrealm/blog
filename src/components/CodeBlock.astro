---
// src/components/CodeBlock.astro
---

<div class="code-block-container relative group">
  <button
    class="copy-button absolute right-3 top-3 p-2 bg-slate-800/40 hover:bg-slate-700/60 rounded-lg border border-slate-700/50 opacity-0 group-hover:opacity-100 transition-all duration-200 z-10 backdrop-blur-sm"
    aria-label="Copy code"
  >
    <svg
      class="w-4 h-4 text-slate-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
      >
      </path>
    </svg>
    <span
      class="copy-success hidden absolute -left-14 top-1/2 -translate-y-1/2 px-2 py-1 bg-emerald-500/90 text-white text-[10px] font-bold rounded shadow-lg whitespace-nowrap backdrop-blur-sm"
    >
      已复制!
    </span>
  </button>
  <div class="code-content prose prose-invert max-w-none">
    <slot />
  </div>
</div>

<style is:global>
  /* Ensure the code block looks good and handles internal spacing */
  .code-block-container pre {
    padding: 1.5em !important;
    border-radius: 1rem !important;
    background-color: #0f172a !important; /* slate-900 */
    border: 1px solid rgba(51, 65, 85, 0.5) !important; /* border-slate-700/50 */
    font-size: 0.875rem !important;
    line-height: 1.7142857 !important;
  }

  .code-block-container code {
    font-family: var(--font-mono);
    background: transparent !important;
    padding: 0 !important;
  }
</style>

<script>
  function setupCopyButtons() {
    const containers = document.querySelectorAll(".code-block-container");

    containers.forEach((container) => {
      const button = container.querySelector(".copy-button");
      if (!button) return;

      // Avoid duplicate listeners
      if (button.hasAttribute("data-has-listener")) return;

      const successMsg = container.querySelector(".copy-success");
      const pre = container.querySelector("pre");

      if (button && pre) {
        button.setAttribute("data-has-listener", "true");
        button.addEventListener("click", async () => {
          const text = pre.textContent || "";
          try {
            await navigator.clipboard.writeText(text);

            // Show success message
            successMsg?.classList.remove("hidden");
            button.classList.add("border-emerald-500/50", "bg-emerald-500/10");

            setTimeout(() => {
              successMsg?.classList.add("hidden");
              button.classList.remove("border-emerald-500/50", "bg-emerald-500/10");
            }, 2000);
          } catch (err) {
            console.error("Failed to copy text: ", err);
          }
        });
      }
    });
  }

  // Run on initial load
  setupCopyButtons();

  // Re-run on Astro view transitions
  document.addEventListener("astro:page-load", setupCopyButtons);
</script>
